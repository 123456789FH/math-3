<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ | ØªØ¯Ø±ÙŠØ¨ ØªÙØ§Ø¹Ù„ÙŠ</title>
  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0b3a66;
      --card:#ffffff;
      --card2:#f7fbff;
      --text:#0f172a;
      --muted:#475569;
      --accent:#0ea5e9;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 16px 32px rgba(2,6,23,.18);
      --shadow2: 0 10px 20px rgba(2,6,23,.12);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Tajawal", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 70% 10%, rgba(34,197,94,.18), transparent 55%),
                  radial-gradient(900px 600px at 10% 20%, rgba(14,165,233,.22), transparent 50%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      padding:24px 14px 70px;
    }
    .wrap{max-width:1100px;margin:0 auto}
    header{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      padding:14px 16px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      color:#fff;
    }
    .title{
      display:flex; gap:12px; align-items:center;
    }
    .badge{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(14,165,233,1), rgba(34,197,94,1));
      display:grid;place-items:center;
      box-shadow: 0 12px 22px rgba(0,0,0,.25);
      font-weight:800;
    }
    h1{margin:0;font-size:18px}
    .sub{margin:2px 0 0;color:rgba(255,255,255,.82);font-size:13px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start}
    .pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.10);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      user-select:none;
      transition:.18s transform, .18s background;
    }
    .pill:hover{transform: translateY(-1px); background: rgba(255,255,255,.14)}
    .grid{
      display:grid; gap:14px;
      grid-template-columns: 360px 1fr;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }
    .panel{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .panel .head{
      padding:12px 14px;
      color:#fff;
      border-bottom:1px solid rgba(255,255,255,.15);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .panel .body{
      padding:14px;
      color:#fff;
    }
    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      border:1px solid rgba(2,6,23,.08);
    }
    .card .head{
      padding:14px 16px;
      background: linear-gradient(90deg, rgba(14,165,233,.14), rgba(34,197,94,.12));
      border-bottom:1px solid rgba(2,6,23,.06);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .head h2{
      margin:0;
      font-size:18px;
      letter-spacing:.1px;
    }
    .meta{
      display:flex; gap:10px; flex-wrap:wrap;
      color:var(--muted);
      font-weight:600;
      font-size:13px;
    }
    .card .body{padding:16px}
    label{display:block;font-weight:700;margin:10px 0 6px}
    select, input[type="text"], input[type="number"]{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(2,6,23,.14);
      background: #fff;
      font-size:16px;
      outline:none;
      transition:.15s border-color, .15s box-shadow;
    }
    select:focus, input:focus{
      border-color: rgba(14,165,233,.8);
      box-shadow: 0 0 0 4px rgba(14,165,233,.15);
    }
    .row{display:grid;grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 650px){ .row{grid-template-columns:1fr} }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 14px;
      border-radius: 16px;
      border:1px solid rgba(2,6,23,.12);
      background: #fff;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      transition: .15s transform, .15s box-shadow, .15s background;
      box-shadow: 0 10px 0 rgba(2,6,23,.08);
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 11px 0 rgba(2,6,23,.09)}
    .btn:active{transform: translateY(4px); box-shadow: 0 6px 0 rgba(2,6,23,.07)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(14,165,233,1), rgba(34,197,94,1));
      color:#fff;
      border-color: rgba(255,255,255,.0);
      box-shadow: 0 12px 0 rgba(2,6,23,.14);
    }
    .btn.ghost{
      background: transparent;
      color: var(--text);
    }
    .btn.small{padding:10px 12px; border-radius: 14px; font-weight:800}
    .btn.danger{background: #fff; border-color: rgba(239,68,68,.35); color: #b91c1c}
    .hint{
      margin-top:10px;
      background: var(--card2);
      border:1px dashed rgba(2,6,23,.20);
      padding:12px 12px;
      border-radius: 16px;
      color: var(--muted);
      line-height:1.7;
    }
    .qbox{
      margin-top:12px;
      border:1px solid rgba(2,6,23,.12);
      border-radius: var(--radius);
      padding:14px;
      background: #fff;
    }
    .qtitle{
      font-size:18px;
      font-weight:900;
      margin:0 0 10px;
      line-height:1.6;
    }
    .choices{display:grid; gap:10px; margin-top:10px}
    .choice{
      border:1px solid rgba(2,6,23,.12);
      border-radius: 16px;
      padding:12px 12px;
      cursor:pointer;
      user-select:none;
      transition:.12s transform, .12s border-color, .12s background;
      display:flex; align-items:center; gap:10px;
      background:#fff;
      box-shadow: 0 10px 0 rgba(2,6,23,.07);
    }
    .choice:hover{transform: translateY(-1px); border-color: rgba(14,165,233,.6); background: rgba(14,165,233,.06)}
    .choice:active{transform: translateY(3px); box-shadow: 0 6px 0 rgba(2,6,23,.06)}
    .choice .dot{
      width:14px;height:14px;border-radius:99px;border:2px solid rgba(2,6,23,.25);
    }
    .choice.selected{border-color: rgba(14,165,233,.85); background: rgba(14,165,233,.08)}
    .choice.selected .dot{border-color: rgba(14,165,233,.95); background: rgba(14,165,233,.95)}
    .bar{
      height:12px;border-radius:999px;background: rgba(2,6,23,.08); overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(14,165,233,1), rgba(34,197,94,1));
      transition: width .25s ease;
    }
    .status{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-top:10px;
      color:var(--muted);
      font-weight:700;
      flex-wrap:wrap;
    }
    .msg{
      margin-top:12px;
      padding:12px 12px;
      border-radius: 16px;
      font-weight:800;
      display:none;
    }
    .msg.ok{display:block; background: rgba(34,197,94,.12); border:1px solid rgba(34,197,94,.28); color:#065f46}
    .msg.bad{display:block; background: rgba(239,68,68,.10); border:1px solid rgba(239,68,68,.22); color:#7f1d1d}
    footer{
      max-width:1100px;
      margin:14px auto 0;
      color: rgba(255,255,255,.85);
      font-weight:700;
      text-align:center;
      font-size:13px;
      padding:10px 12px;
    }
    .kbd{
      padding:3px 8px;border-radius:10px;
      border:1px solid rgba(2,6,23,.14);
      background:#fff;
      color:var(--muted);
      font-weight:900;
      font-size:12px;
    }
    .mini{
      font-size:12px;color:rgba(255,255,255,.82);
      line-height:1.6;
    }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius: 999px;
      border:1px solid rgba(2,6,23,.10);
      background:#fff;
      color:var(--muted);
      font-weight:800;
      font-size:12px;
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <div class="badge">Ù£</div>
        <div>
          <h1>Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø«Ø§Ù„Ø« Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</h1>
          <div class="sub">ØªØ¯Ø±ÙŠØ¨ ØªÙØ§Ø¹Ù„ÙŠ (Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ) â€” Ø§Ø®ØªØ± Ù…Ù‡Ø§Ø±Ø© Ø«Ù… Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</div>
        </div>
      </div>
      <div class="actions">
        <div class="pill" id="btnResetAll">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…</div>
        <div class="pill" id="btnTips">Ù†ØµØ§Ø¦Ø­ Ø³Ø±ÙŠØ¹Ø©</div>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Modules -->
      <div class="panel">
        <div class="head">
          <div style="font-weight:900">Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</div>
          <div class="mini">ØªÙ„Ù…ÙŠØ­: Ø§Ø¶ØºØ·ÙŠ <span class="kbd">Enter</span> Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</div>
        </div>
        <div class="body" id="moduleList"></div>
      </div>

      <!-- Right: Activity -->
      <div class="card">
        <div class="head">
          <h2 id="activityTitle">Ø§Ø¨Ø¯Ø¦ÙŠ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ù…Ù‡Ø§Ø±Ø©</h2>
          <div class="meta">
            <span class="tag" id="tagMode">Ø¬Ø§Ù‡Ø²</span>
            <span class="tag" id="tagScore">Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ù  / Ù </span>
            <span class="tag" id="tagStreak">Ø³Ù„Ø³Ù„Ø©: Ù </span>
          </div>
        </div>

        <div class="body">
          <div class="row">
            <div>
              <label for="difficulty">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</label>
              <select id="difficulty">
                <option value="easy">Ø³Ù‡Ù„</option>
                <option value="med" selected>Ù…ØªÙˆØ³Ø·</option>
                <option value="hard">Ù…ØªÙ‚Ø¯Ù…</option>
              </select>
            </div>
            <div>
              <label for="count">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
              <select id="count">
                <option value="5">Ù¥</option>
                <option value="10" selected>Ù¡Ù </option>
                <option value="15">Ù¡Ù¥</option>
                <option value="20">Ù¢Ù </option>
              </select>
            </div>
          </div>

          <div class="hint" id="explainBox">
            ğŸ‘ˆ Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ù‡Ø§Ø±Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ø«Ù… Ø§Ø¶ØºØ·ÙŠ <b>Ø§Ø¨Ø¯Ø£</b>.  
            <br/>Ø³ØªØ¸Ù‡Ø± Ù„Ùƒ Ø£Ø³Ø¦Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù…). ÙƒÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ØªÙØ¹Ø±Ø¶ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ.
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
            <button class="btn primary" id="btnStart">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</button>
            <button class="btn" id="btnNext" disabled>Ø§Ù„ØªØ§Ù„ÙŠ</button>
            <button class="btn danger" id="btnStop" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>
          </div>

          <div style="margin-top:12px">
            <div class="bar"><div id="progressFill"></div></div>
            <div class="status">
              <div id="progressText">Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…: Ù Ùª</div>
              <div id="timeText">Ø§Ù„ÙˆÙ‚Øª: Ù  Ø«Ø§Ù†ÙŠØ©</div>
            </div>
          </div>

          <div class="qbox" id="questionBox" style="display:none">
            <div id="qKind" class="tag" style="margin-bottom:10px">Ø³Ø¤Ø§Ù„</div>
            <div class="qtitle" id="qPrompt">â€”</div>

            <div id="mcqArea" style="display:none">
              <div class="choices" id="choices"></div>
            </div>

            <div id="inputArea" style="display:none">
              <label for="answerInput">Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</label>
              <input id="answerInput" type="text" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: Ù¡Ù¢Ù£" />
              <div class="mini" style="margin-top:6px;color:var(--muted)">ØªÙ‚Ø¨Ù„: 123 Ø£Ùˆ Ù¡Ù¢Ù£ âœ…</div>
              <div style="margin-top:10px">
                <button class="btn small primary" id="btnSubmit">ØªØ­Ù‚Ù‘Ù‚</button>
              </div>
            </div>

            <div class="msg" id="msgBox"></div>
          </div>

          <div class="hint" id="tipsBox" style="display:none"></div>
        </div>
      </div>
    </div>

    <footer>
      Ø£/ ÙØ§Ø·Ù…Ø© Ù‡Ø²Ø§Ø²ÙŠ â€” Ù…Ù„ØªÙ‚Ù‰ Ù…Ø¹Ù„Ù…ÙŠ ÙˆÙ…Ø¹Ù„Ù…Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª â€” Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ
    </footer>
  </div>

<script>
/* =======================
   Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±Ø¨ÙŠØ© (Ù‡Ù†Ø¯ÙŠØ©) + Ø£Ø¯ÙˆØ§Øª
======================= */
const AR = ["Ù ","Ù¡","Ù¢","Ù£","Ù¤","Ù¥","Ù¦","Ù§","Ù¨","Ù©"];
function toArabicDigits(input){
  const s = String(input);
  return s.replace(/\d/g, d => AR[Number(d)]);
}
function fromArabicDigits(input){
  if (input == null) return "";
  let s = String(input).trim();
  // normalize Arabic-Indic digits to western
  s = s.replace(/[Ù -Ù©]/g, ch => String(AR.indexOf(ch)));
  s = s.replace(/,/g, "").replace(/Ù¬/g,""); // remove commas
  s = s.replace(/[^\d\-]/g, ""); // keep digits and minus
  return s;
}
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function fmtNum(n){
  // keep as integer
  return toArabicDigits(n);
}
function fmtList(nums){
  return nums.map(n=>fmtNum(n)).join("ØŒ ");
}
function pluralQuestions(n){
  return fmtNum(n) + " Ø³Ø¤Ø§Ù„";
}

/* =======================
   ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª
======================= */
const MODULES = [
  {
    id:"patterns",
    name:"Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¹Ø¯Ø¯ÙŠØ©",
    icon:"ğŸ”¢",
    explain:[
      "Ø£Ø­Ø¯Ø¯ Ù‡Ù„ Ø§Ù„Ù†Ù…Ø· ÙŠØªØ²Ø§ÙŠØ¯ Ø£Ù… ÙŠØªÙ†Ø§Ù‚Øµ.",
      "Ø£Ø³ØªØ®Ø±Ø¬ Ù…Ù‚Ø¯Ø§Ø± Ø§Ù„ØªØºÙŠØ± (Ù…Ø«Ù„ +Ù£ Ø£Ùˆ âˆ’Ù¥).",
      "Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ù…Ø·."
    ],
    gen: genPatterns
  },
  {
    id:"place",
    name:"Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© + Ø§Ù„ØµÙŠØº",
    icon:"ğŸ·ï¸",
    explain:[
      "Ø£Ø­Ø¯Ø¯ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø²Ù„Ø© (Ø¢Ø­Ø§Ø¯/Ø¹Ø´Ø±Ø§Øª/Ù…Ø¦Ø§Øª/Ø£Ù„ÙˆÙ).",
      "Ø£Ø¬Ø¯ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© Ù„Ù„Ø±Ù‚Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯.",
      "Ø£Ù…ÙŠÙ‘Ø² Ø¨ÙŠÙ† Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ© ÙˆØ§Ù„Ù„ÙØ¸ÙŠØ©."
    ],
    gen: genPlaceValue
  },
  {
    id:"compare",
    name:"Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ (>,<,=)",
    icon:"âš–ï¸",
    explain:[
      "Ø£Ù‚Ø§Ø±Ù† Ù…Ù† Ø£ÙƒØ¨Ø± Ù…Ù†Ø²Ù„Ø© (Ø§Ù„Ø£Ù„ÙˆÙ Ø«Ù… Ø§Ù„Ù…Ø¦Ø§Øª...).",
      "Ø£Ø®ØªØ§Ø± Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ù†Ø§Ø³Ø¨: > Ø£Ùˆ < Ø£Ùˆ =."
    ],
    gen: genCompare
  },
  {
    id:"order",
    name:"ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯",
    icon:"ğŸ“š",
    explain:[
      "Ø£Ø±ØªÙ‘Ø¨ Ù…Ù† Ø§Ù„Ø£ØµØºØ± Ù„Ù„Ø£ÙƒØ¨Ø± Ø£Ùˆ Ù…Ù† Ø§Ù„Ø£ÙƒØ¨Ø± Ù„Ù„Ø£ØµØºØ±.",
      "Ø£Ø¨Ø¯Ø£ Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø«Ù… Ø£Ù‚Ø§Ø±Ù† Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø±."
    ],
    gen: genOrder
  },
  {
    id:"round",
    name:"Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ (Ø¹Ø´Ø±Ø©/Ù…Ø¦Ø©/Ø£Ù„Ù)",
    icon:"ğŸ¯",
    explain:[
      "Ø§Ù„Ø¨Ø®ÙŠÙ„Ø©: Ù ØŒÙ¡ØŒÙ¢ØŒÙ£ØŒÙ¤ â† Ø£Ù†Ø²Ù„.",
      "Ø§Ù„ÙƒØ±ÙŠÙ…Ø©: Ù¥ØŒÙ¦ØŒÙ§ØŒÙ¨ØŒÙ© â† Ø£Ø·Ù„Ø¹.",
      "Ø§Ù„Ù…ØªÙ†Ø§ØºÙ…Ø©: Ù£ØŒÙ¤ØŒÙ¥ØŒÙ¦ØŒÙ§ ØªÙÙ‚Ø±Ø¨ Ø¥Ù„Ù‰ Ù¥."
    ],
    gen: genRounding
  },
  {
    id:"add_props",
    name:"Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø¬Ù…Ø¹",
    icon:"â•",
    explain:[
      "Ø§Ù„Ø¥Ø¨Ø¯Ø§Ù„ÙŠØ©: a+b = b+a",
      "Ø§Ù„ØªØ¬Ù…ÙŠØ¹: (a+b)+c = a+(b+c)",
      "Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø­Ø§ÙŠØ¯: a+0 = a"
    ],
    gen: genAddProps
  },
  {
    id:"estimate_type",
    name:"ØªÙ…ÙŠÙŠØ² Ù†ÙˆØ¹ Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¬Ù…Ø¹",
    icon:"ğŸ§ ",
    explain:[
      "Ø£Ù‚Ø¯Ù‘Ø± Ø¨Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ (Ø¨Ø®ÙŠÙ„Ø©/ÙƒØ±ÙŠÙ…Ø©).",
      "Ø£Ù‚Ø¯Ù‘Ø± Ø¨Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙ†Ø§ØºÙ…Ø©.",
      "Ø£Ø¬Ø¯ Ø§Ù„Ù†Ø§ØªØ¬ (Ø¯Ù‚ÙŠÙ‚ Ø¨Ø¯ÙˆÙ† ØªÙ‚Ø±ÙŠØ¨)."
    ],
    gen: genEstimateType
  },
  {
    id:"exact_or_est",
    name:"Ø§Ù„Ø¬ÙˆØ§Ø¨ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ Ø£Ù… Ø§Ù„Ø¯Ù‚ÙŠÙ‚ØŸ",
    icon:"ğŸ”",
    explain:[
      "ÙˆØ¬ÙˆØ¯: ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§/Ø­ÙˆØ§Ù„ÙŠ/Ø£Ù‚Ø¯Ù‘Ø± â†’ Ø§Ù„Ø¬ÙˆØ§Ø¨ ØªÙ‚Ø¯ÙŠØ±ÙŠ.",
      "Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯Ù‡Ø§ â†’ Ø§Ù„Ø¬ÙˆØ§Ø¨ Ø¯Ù‚ÙŠÙ‚."
    ],
    gen: genExactOrEstimate
  },
  {
    id:"sub",
    name:"Ø§Ù„Ø·Ø±Ø­ (Ù…Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù)",
    icon:"â–",
    explain:[
      "Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù: ÙŠÙ†Ù‚Øµ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙ„Ù Ù…Ù†Ù‡ (Ø§Ù„Ø¹Ø´Ø±Ø§Øª/Ø§Ù„Ù…Ø¦Ø§Øª).",
      "Ø£Ø­Ù„ Ø·Ø±Ø­Ù‹Ø§ Ø¨Ø¯Ù‚Ø© Ø£Ùˆ ØªÙ‚Ø¯ÙŠØ±Ù‹Ø§ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨."
    ],
    gen: genSubtraction
  },
  {
    id:"mul",
    name:"Ø§Ù„Ø¶Ø±Ø¨ (Ø¬Ø¯Ø§ÙˆÙ„ + Ù†Ù…Ø§Ø°Ø¬)",
    icon:"âœ–ï¸",
    explain:[
      "Ø£Ø­ÙØ¸ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¶Ø±Ø¨ ÙˆØ£Ø·Ø¨Ù‚Ù‡Ø§.",
      "Ø£Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø´Ø¨ÙƒØ§Øª/Ø§Ù„Ù†Ù…Ø§Ø°Ø¬/Ø§Ù„Ø¹Ø¯ Ø§Ù„Ù‚ÙØ²ÙŠ.",
      "Ø£Ø¶Ø±Ø¨ Ø¹Ø¯Ø¯ÙŠÙ† ÙˆØ£Ø­ÙŠØ§Ù†Ù‹Ø§ Ù£ Ø£Ø¹Ø¯Ø§Ø¯ (Ø¨Ø§Ù„ØªØ¯Ø±Ù‘Ø¬)."
    ],
    gen: genMultiplication
  },
];

function getDifficulty(){
  return document.getElementById("difficulty").value;
}
function getCount(){
  return Number(fromArabicDigits(document.getElementById("count").value));
}

/* =======================
   Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„ÙƒÙ„ Ù…Ù‡Ø§Ø±Ø©
======================= */

function genPatterns(diff){
  const kind = pick(["missing","direction"]);
  const base = diff==="easy" ? randInt(0,30) : diff==="med" ? randInt(0,70) : randInt(0,200);
  let stepChoices = diff==="easy" ? [1,2,3,4,5] : diff==="med" ? [2,3,4,5,6,7,8,9,10] : [3,4,5,6,7,8,9,10,12,15,20];
  let step = pick(stepChoices);
  const isInc = Math.random() < 0.6;
  step = isInc ? step : -step;
  const len = 5;
  const seq = [];
  for(let i=0;i<len;i++) seq.push(base + i*step);
  // make sure no negative in easy
  if(diff==="easy" && seq.some(x=>x<0)) return genPatterns(diff);

  if(kind==="direction"){
    const prompt = `Ø§Ù„Ù†Ù…Ø·: ${fmtList(seq)}<br/>Ù‡Ù„ Ù‡Ùˆ <b>ÙŠØªØ²Ø§ÙŠØ¯</b> Ø£Ù… <b>ÙŠØªÙ†Ø§Ù‚Øµ</b>ØŸ`;
    const answer = step>0 ? "ÙŠØªØ²Ø§ÙŠØ¯" : "ÙŠØªÙ†Ø§Ù‚Øµ";
    const choices = shuffle(["ÙŠØªØ²Ø§ÙŠØ¯","ÙŠØªÙ†Ø§Ù‚Øµ"]);
    return {type:"mcq", kind:"Ø§Ù„Ø£Ù†Ù…Ø§Ø·", prompt, choices, answer, explain: `Ù„Ø£Ù† Ø§Ù„ØªØºÙŠØ± ÙƒÙ„ Ù…Ø±Ø© = ${toArabicDigits(step>0? "+"+step : step)}.`};
  }else{
    const missIndex = randInt(1,len-2);
    const shown = seq.slice();
    const ans = shown[missIndex];
    shown[missIndex] = "___";
    const prompt = `Ø£ÙƒÙ…Ù„ Ø§Ù„Ù†Ù…Ø·: <b>${shown.map(x=> typeof x==="number"? fmtNum(x) : x).join("ØŒ ")}</b>`;
    // generate plausible options
    const wrong1 = ans + step;
    const wrong2 = ans - step;
    const wrong3 = ans + (step>0? step+1 : step-1);
    const opts = shuffle([ans, wrong1, wrong2, wrong3].map(x=> fmtNum(x)));
    return {type:"mcq", kind:"Ø§Ù„Ø£Ù†Ù…Ø§Ø·", prompt, choices: opts, answer: fmtNum(ans),
      explain: `Ù†Ù„Ø§Ø­Ø¸ Ù…Ù‚Ø¯Ø§Ø± Ø§Ù„ØªØºÙŠØ± Ø«Ø§Ø¨Øª (${toArabicDigits(step>0? "+"+Math.abs(step) : "-"+Math.abs(step))}) Ø«Ù… Ù†ÙƒÙ…Ù„.`};
  }
}

function genPlaceValue(diff){
  // number length
  const digits = diff==="easy" ? 3 : diff==="med" ? pick([3,4]) : 4;
  const min = digits===3 ? 100 : 1000;
  const max = digits===3 ? 999 : 9999;
  const n = randInt(min,max);
  const s = String(n);
  // pick a position
  const idx = randInt(0, s.length-1); // from left
  const digit = Number(s[idx]);
  const posFromRight = s.length-1-idx;
  const placeNames = ["Ø¢Ø­Ø§Ø¯","Ø¹Ø´Ø±Ø§Øª","Ù…Ø¦Ø§Øª","Ø£Ù„ÙˆÙ"];
  const place = placeNames[posFromRight];
  const value = digit * Math.pow(10,posFromRight);

  const kind = pick(["placeName","placeValue","expanded"]);
  if(kind==="placeName"){
    const prompt = `ÙÙŠ Ø§Ù„Ø¹Ø¯Ø¯ <b>${fmtNum(n)}</b>ØŒ Ù…Ø§ <b>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø²Ù„Ø©</b> Ù„Ù„Ø±Ù‚Ù… <b>${fmtNum(digit)}</b>ØŸ`;
    const pool = placeNames.slice(0, s.length);
    const choices = shuffle(pool);
    return {type:"mcq", kind:"Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©", prompt, choices, answer: place,
      explain: `Ù†Ø¹Ø¯Ù‘ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ†: Ø¢Ø­Ø§Ø¯ Ø«Ù… Ø¹Ø´Ø±Ø§Øª Ø«Ù… Ù…Ø¦Ø§Øª Ø«Ù… Ø£Ù„ÙˆÙ.`};
  }
  if(kind==="placeValue"){
    const prompt = `ÙÙŠ Ø§Ù„Ø¹Ø¯Ø¯ <b>${fmtNum(n)}</b>ØŒ Ù…Ø§ <b>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©</b> Ù„Ù„Ø±Ù‚Ù… <b>${fmtNum(digit)}</b>ØŸ`;
    // options
    const wrongs = new Set();
    while(wrongs.size<3){
      const otherPos = randInt(0, s.length-1);
      const v = digit * Math.pow(10, otherPos);
      if(v!==value) wrongs.add(v);
    }
    const choices = shuffle([value, ...Array.from(wrongs)].map(fmtNum));
    return {type:"mcq", kind:"Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©", prompt, choices, answer: fmtNum(value),
      explain: `Ø§Ù„Ù‚ÙŠÙ…Ø© = Ø§Ù„Ø±Ù‚Ù… Ã— Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†Ø²Ù„Ø©.`};
  }
  // expanded (multiple choice)
  const parts = [];
  for(let i=0;i<s.length;i++){
    const d = Number(s[i]);
    const p = s.length-1-i;
    if(d!==0) parts.push(d*Math.pow(10,p));
  }
  const expanded = parts.map(fmtNum).join(" + ");
  const prompt = `Ø§Ø®ØªØ± <b>Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ©</b> Ù„Ù„Ø¹Ø¯Ø¯ <b>${fmtNum(n)}</b>:`;
  const wrongA = parts.slice().reverse().map(fmtNum).join(" + ");
  const wrongB = (n + randInt(1,9)*Math.pow(10,randInt(0,s.length-1)));
  const wrongC = parts.map(x=> fmtNum(x)).join(" - ");
  const choices = shuffle([expanded, wrongA, fmtNum(wrongB), wrongC]);
  return {type:"mcq", kind:"Ø§Ù„ØµÙŠØº", prompt, choices, answer: expanded,
    explain: `Ù†ÙƒØªØ¨ Ø§Ù„Ø¹Ø¯Ø¯ Ù…Ø¬Ù…ÙˆØ¹ Ù‚ÙŠÙ… Ù…Ù†Ø§Ø²Ù„Ù‡ (Ø£Ù„ÙˆÙ + Ù…Ø¦Ø§Øª + Ø¹Ø´Ø±Ø§Øª + Ø¢Ø­Ø§Ø¯).`};
}

function genCompare(diff){
  const digits = diff==="easy" ? 3 : diff==="med" ? pick([3,4]) : 4;
  const min = digits===3 ? 100 : 1000;
  const max = digits===3 ? 999 : 9999;
  let a = randInt(min,max), b = randInt(min,max);
  if(diff!=="easy" && Math.random()<0.2) b = a; // sometimes equal
  const prompt = `Ø§Ø®ØªØ± Ø§Ù„Ø±Ù…Ø² Ø§Ù„ØµØ­ÙŠØ­: <b>${fmtNum(a)} ___ ${fmtNum(b)}</b>`;
  const answer = a>b ? ">" : a<b ? "<" : "=";
  const choices = shuffle([">","<","="]);
  return {type:"mcq", kind:"Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©", prompt, choices, answer,
    explain: `Ù†Ù‚Ø§Ø±Ù† Ù…Ù† Ø£ÙƒØ¨Ø± Ù…Ù†Ø²Ù„Ø©.`};
}

function genOrder(diff){
  const digits = diff==="easy" ? 3 : diff==="med" ? pick([3,4]) : 4;
  const min = digits===3 ? 100 : 1000;
  const max = digits===3 ? 999 : 9999;
  const count = 4;
  const nums = new Set();
  while(nums.size<count) nums.add(randInt(min,max));
  const arr = Array.from(nums);
  const mode = Math.random()<0.5 ? "asc" : "desc";
  const prompt = `Ø±ØªÙ‘Ø¨ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ <b>${mode==="asc" ? "Ù…Ù† Ø§Ù„Ø£ØµØºØ± Ù„Ù„Ø£ÙƒØ¨Ø±" : "Ù…Ù† Ø§Ù„Ø£ÙƒØ¨Ø± Ù„Ù„Ø£ØµØºØ±"}</b>:<br/><b>${fmtList(arr)}</b>`;
  const sorted = arr.slice().sort((x,y)=> mode==="asc" ? x-y : y-x);
  const correct = fmtList(sorted);
  // create wrong options by swapping
  const w1 = sorted.slice(); [w1[1],w1[2]]=[w1[2],w1[1]];
  const w2 = sorted.slice().reverse();
  const w3 = sorted.slice(); [w3[0],w3[3]]=[w3[3],w3[0]];
  const choices = shuffle([correct, fmtList(w1), fmtList(w2), fmtList(w3)]);
  return {type:"mcq", kind:"Ø§Ù„ØªØ±ØªÙŠØ¨", prompt, choices, answer: correct,
    explain: `Ù†Ù‚Ø§Ø±Ù† Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± (Ø£ÙƒØ¨Ø± Ù…Ù†Ø²Ù„Ø©) Ø«Ù… Ù†Ø±ØªÙ‘Ø¨.`};
}

function roundTo(n, place){ // place: 10,100,1000
  const r = Math.round(n/place)*place;
  return r;
}
function genRounding(diff){
  const place = pick([10,100,1000].filter(p => diff==="easy" ? p!==1000 : true));
  const min = place===10 ? 10 : place===100 ? 100 : 1000;
  const max = place===10 ? 999 : place===100 ? 9999 : 9999;
  const n = randInt(min,max);
  const ans = roundTo(n, place);
  const prompt = `Ù‚Ø±Ù‘Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ <b>${fmtNum(n)}</b> Ø¥Ù„Ù‰ <b>Ø£Ù‚Ø±Ø¨ ${place===10?"Ø¹Ø´Ø±Ø©":place===100?"Ù…Ø¦Ø©":"Ø£Ù„Ù"}</b>`;
  // wrong options
  const down = Math.floor(n/place)*place;
  const up = down + place;
  const near = ans;
  const weird = ans + (Math.random()<0.5 ? place : -place);
  const choices = shuffle([near, down, up, clamp(weird,0,9999)].map(fmtNum));
  return {type:"mcq", kind:"Ø§Ù„ØªÙ‚Ø±ÙŠØ¨", prompt, choices, answer: fmtNum(ans),
    explain: `Ø§Ù†Ø¸Ø± Ù„Ù„Ø±Ù‚Ù… Ø§Ù„Ø°ÙŠ Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ† Ù…Ù†Ø²Ù„Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨: Ø¨Ø®ÙŠÙ„Ø© ØªÙ†Ø²Ù„ØŒ ÙƒØ±ÙŠÙ…Ø© ØªØ·Ù„Ø¹.`};
}

function genAddProps(diff){
  const a = randInt(1, diff==="easy"? 9 : 20);
  const b = randInt(1, diff==="easy"? 9 : 20);
  const c = randInt(1, diff==="easy"? 9 : 20);
  const kind = pick(["comm","assoc","identity"]);
  let prompt="", answer="", explain="";
  if(kind==="comm"){
    prompt = `Ø£ÙŠ Ø®Ø§ØµÙŠØ© ÙÙŠ Ø§Ù„Ø¬Ù…Ø¹ ØªÙˆØ¶Ù‘Ø­ Ø£Ù†:<br/><b>${fmtNum(a)} + ${fmtNum(b)} = ${fmtNum(b)} + ${fmtNum(a)}</b> ØŸ`;
    answer = "Ø§Ù„Ø®Ø§ØµÙŠØ© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ù„ÙŠØ©";
    explain = "ØªØ¨Ø¯ÙŠÙ„ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø¯Ø¯ÙŠÙ† Ù„Ø§ ÙŠØºÙŠÙ‘Ø± Ø§Ù„Ù†Ø§ØªØ¬.";
  }else if(kind==="assoc"){
    prompt = `Ø£ÙŠ Ø®Ø§ØµÙŠØ© ÙÙŠ Ø§Ù„Ø¬Ù…Ø¹ ØªÙˆØ¶Ù‘Ø­ Ø£Ù†:<br/><b>(${fmtNum(a)} + ${fmtNum(b)}) + ${fmtNum(c)} = ${fmtNum(a)} + (${fmtNum(b)} + ${fmtNum(c)})</b> ØŸ`;
    answer = "Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØ¬Ù…ÙŠØ¹";
    explain = "ØªØºÙŠÙŠØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ù„Ø§ ÙŠØºÙŠÙ‘Ø± Ø§Ù„Ù†Ø§ØªØ¬.";
  }else{
    prompt = `Ø£ÙŠ Ø®Ø§ØµÙŠØ© ÙÙŠ Ø§Ù„Ø¬Ù…Ø¹ ØªÙˆØ¶Ù‘Ø­ Ø£Ù†:<br/><b>${fmtNum(a)} + Ù  = ${fmtNum(a)}</b> ØŸ`;
    answer = "Ø®Ø§ØµÙŠØ© Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø­Ø§ÙŠØ¯";
    explain = "Ø§Ù„ØµÙØ± Ù„Ø§ ÙŠØºÙŠÙ‘Ø± Ø§Ù„Ù†Ø§ØªØ¬ Ø¹Ù†Ø¯ Ø§Ù„Ø¬Ù…Ø¹.";
  }
  const choices = shuffle(["Ø§Ù„Ø®Ø§ØµÙŠØ© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ù„ÙŠØ©","Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØ¬Ù…ÙŠØ¹","Ø®Ø§ØµÙŠØ© Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø­Ø§ÙŠØ¯"]);
  return {type:"mcq", kind:"Ø®ØµØ§Ø¦Øµ Ø§Ù„Ø¬Ù…Ø¹", prompt, choices, answer, explain};
}

function genEstimateType(diff){
  // Decide which of 3 types
  const type = pick(["rounding","compatible","exact"]);
  const a = randInt(diff==="easy"? 10:30, diff==="hard"? 999:299);
  const b = randInt(diff==="easy"? 10:30, diff==="hard"? 999:299);

  let prompt = `Ø§Ù„Ø³Ø¤Ø§Ù„: `;
  let answer="", explain="";
  if(type==="rounding"){
    prompt += `Ø£Ù‚Ø¯Ù‘Ø± Ù†Ø§ØªØ¬ Ø§Ù„Ø¬Ù…Ø¹ Ø¨Ø§Ø³ØªØ¹Ù…Ø§Ù„ <b>Ø§Ù„ØªÙ‚Ø±ÙŠØ¨</b>:<br/><b>${fmtNum(a)} + ${fmtNum(b)}</b>`;
    answer = "ØªÙ‚Ø¯ÙŠØ± Ø¨Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ (Ø¨Ø®ÙŠÙ„Ø©/ÙƒØ±ÙŠÙ…Ø©)";
    explain = "Ù†Ù‚Ø±Ù‘Ø¨ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø«Ù… Ù†Ø¬Ù…Ø¹ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§.";
  }else if(type==="compatible"){
    // make them near compatible tens/hundreds
    const aa = Math.round(a/10)*10 + pick([-1,0,1,2,-2]);
    const bb = Math.round(b/10)*10 + pick([-1,0,1,2,-2]);
    prompt += `Ø£Ù‚Ø¯Ù‘Ø± Ù†Ø§ØªØ¬ Ø§Ù„Ø¬Ù…Ø¹ Ø¨Ø§Ø³ØªØ¹Ù…Ø§Ù„ <b>Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙ†Ø§ØºÙ…Ø©</b>:<br/><b>${fmtNum(aa)} + ${fmtNum(bb)}</b>`;
    answer = "ØªÙ‚Ø¯ÙŠØ± Ø¨Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙ†Ø§ØºÙ…Ø©";
    explain = "Ù†Ø®ØªØ§Ø± Ø£Ø¹Ø¯Ø§Ø¯Ù‹Ø§ Ù‚Ø±ÙŠØ¨Ø© ÙˆØ³Ù‡Ù„Ø© Ø§Ù„Ø¬Ù…Ø¹ (Ù…Ø«Ù„ Ù¤Ù©â‰ˆÙ¥Ù ).";
  }else{
    prompt += `Ø£Ø¬Ø¯ Ù†Ø§ØªØ¬ Ø§Ù„Ø¬Ù…Ø¹ (Ø¨Ø¯ÙˆÙ† ØªÙ‚Ø±ÙŠØ¨):<br/><b>${fmtNum(a)} + ${fmtNum(b)}</b>`;
    answer = "Ø¬Ù…Ø¹ Ø¯Ù‚ÙŠÙ‚ (Ø¨Ø¯ÙˆÙ† ØªÙ‚Ø±ÙŠØ¨)";
    explain = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù„Ù„ØªÙ‚Ø¯ÙŠØ± Ø£Ùˆ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨.";
  }

  const choices = shuffle(["ØªÙ‚Ø¯ÙŠØ± Ø¨Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ (Ø¨Ø®ÙŠÙ„Ø©/ÙƒØ±ÙŠÙ…Ø©)","ØªÙ‚Ø¯ÙŠØ± Ø¨Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙ†Ø§ØºÙ…Ø©","Ø¬Ù…Ø¹ Ø¯Ù‚ÙŠÙ‚ (Ø¨Ø¯ÙˆÙ† ØªÙ‚Ø±ÙŠØ¨)"]);
  return {type:"mcq", kind:"Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„", prompt, choices, answer, explain};
}

function genExactOrEstimate(diff){
  const estWords = ["ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§","Ø­ÙˆØ§Ù„ÙŠ","Ø£Ù‚Ø¯Ù‘Ø±","Ù‚Ø±ÙŠØ¨ Ù…Ù†"];
  const exactWords = ["Ø£Ø¬Ø¯","Ø§Ø­Ø³Ø¨","Ø£ÙˆØ¬Ø¯","Ù…Ø§ Ø§Ù„Ù†Ø§ØªØ¬"];
  const isEst = Math.random() < 0.5;
  const a = randInt(25, diff==="hard"? 999:199);
  const b = randInt(25, diff==="hard"? 999:199);
  const verb = isEst ? pick(estWords) : pick(exactWords);
  const prompt = `Ø§Ù„Ù…Ø³Ø£Ù„Ø©: <b>${verb}</b> Ù†Ø§ØªØ¬ Ø¬Ù…Ø¹ <b>${fmtNum(a)}</b> Ùˆ <b>${fmtNum(b)}</b>.<br/>Ù‡Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ <b>ØªÙ‚Ø¯ÙŠØ±ÙŠ</b> Ø£Ù… <b>Ø¯Ù‚ÙŠÙ‚</b>ØŸ`;
  const answer = isEst ? "ØªÙ‚Ø¯ÙŠØ±ÙŠ" : "Ø¯Ù‚ÙŠÙ‚";
  const choices = shuffle(["ØªÙ‚Ø¯ÙŠØ±ÙŠ","Ø¯Ù‚ÙŠÙ‚"]);
  const explain = isEst ? "ÙˆØ¬ÙˆØ¯ ÙƒÙ„Ù…Ø© Ù…Ø«Ù„ (ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§/Ø­ÙˆØ§Ù„ÙŠ/Ø£Ù‚Ø¯Ù‘Ø±) ÙŠØ¹Ù†ÙŠ ØªÙ‚Ø¯ÙŠØ±ÙŠ." : "Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ÙƒÙ„Ù…Ø§Øª ØªÙ‚Ø¯ÙŠØ± ÙŠØ¹Ù†ÙŠ Ø¯Ù‚ÙŠÙ‚.";
  return {type:"mcq", kind:"ØªÙ‚Ø¯ÙŠØ±ÙŠ Ø£Ù… Ø¯Ù‚ÙŠÙ‚", prompt, choices, answer, explain};
}

function genSubtraction(diff){
  // ensure borrowing frequently
  const max = diff==="easy" ? 200 : diff==="med" ? 999 : 9999;
  const min = diff==="easy" ? 50 : diff==="med" ? 100 : 1000;
  let a = randInt(min,max);
  let b = randInt(min, Math.min(a-1, max-1));
  if(a<=b) [a,b]=[b+10,b];
  // force borrowing: make ones of a smaller than ones of b sometimes
  if(Math.random()<0.7){
    const onesA = randInt(0,8);
    const onesB = randInt(onesA+1,9);
    a = a - (a%10) + onesA;
    b = b - (b%10) + onesB;
    if(a<=b) a += 20;
  }
  const ans = a-b;
  const prompt = `Ø£ÙˆØ¬Ø¯ Ù†Ø§ØªØ¬ Ø§Ù„Ø·Ø±Ø­ (Ø§Ù†ØªØ¨Ù‡ Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù Ø¥Ù† ÙˆÙØ¬Ø¯):<br/><b>${fmtNum(a)} âˆ’ ${fmtNum(b)} = ØŸ</b>`;
  return {type:"input", kind:"Ø§Ù„Ø·Ø±Ø­", prompt, answer: String(ans), explain:"Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù ÙŠÙ†Ù‚Øµ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙ„Ù Ù…Ù†Ù‡ Ø«Ù… Ù†ÙƒÙ…Ù„ Ø§Ù„Ø·Ø±Ø­."};
}

function genMultiplication(diff){
  const kind = pick(["table","three"]);
  let a,b,c=null;
  if(kind==="table"){
    a = randInt(2, diff==="easy"? 6 : diff==="med"? 9 : 12);
    b = randInt(0, diff==="easy"? 10 : 12);
    const ans = a*b;
    const prompt = `Ø£ÙˆØ¬Ø¯ Ù†Ø§ØªØ¬ Ø§Ù„Ø¶Ø±Ø¨:<br/><b>${fmtNum(a)} Ã— ${fmtNum(b)} = ØŸ</b>`;
    // sometimes MCQ, sometimes input
    if(Math.random()<0.55){
      const wrongs = new Set();
      while(wrongs.size<3){
        const w = ans + pick([-a, -b, -2, -1, 1, 2, a, b, 3, -3]);
        if(w>=0 && w!==ans) wrongs.add(w);
      }
      const choices = shuffle([ans, ...Array.from(wrongs)].map(fmtNum));
      return {type:"mcq", kind:"Ø§Ù„Ø¶Ø±Ø¨", prompt, choices, answer: fmtNum(ans),
        explain:"ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙÙƒÙŠØ± Ø¨Ø§Ù„Ø¹Ø¯ Ø§Ù„Ù‚ÙØ²ÙŠ Ø£Ùˆ Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ùˆ Ø§Ù„Ø¬Ø¯ÙˆÙ„."};
    }else{
      return {type:"input", kind:"Ø§Ù„Ø¶Ø±Ø¨", prompt, answer: String(ans),
        explain:"Ø§Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¶Ø±Ø¨ Ø£Ùˆ Ø§Ù„Ø¹Ø¯ Ø§Ù„Ù‚ÙØ²ÙŠ."};
    }
  }else{
    a = randInt(2, diff==="easy"? 5 : 7);
    b = randInt(2, diff==="easy"? 5 : 8);
    c = randInt(2, diff==="easy"? 4 : 6);
    const ans = a*b*c;
    const prompt = `Ø§Ø¶Ø±Ø¨ Ù£ Ø£Ø¹Ø¯Ø§Ø¯ (Ø¨Ø§Ù„ØªØ¯Ø±Ù‘Ø¬):<br/><b>${fmtNum(a)} Ã— ${fmtNum(b)} Ã— ${fmtNum(c)} = ØŸ</b>`;
    return {type:"input", kind:"Ø§Ù„Ø¶Ø±Ø¨ (Ù£ Ø£Ø¹Ø¯Ø§Ø¯)", prompt, answer: String(ans),
      explain:"Ø§Ø¨Ø¯Ø£ Ø¨Ø¶Ø±Ø¨ Ø¹Ø¯Ø¯ÙŠÙ† Ø«Ù… Ø§Ø¶Ø±Ø¨ Ø§Ù„Ù†Ø§ØªØ¬ ÙÙŠ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø«Ø§Ù„Ø«."};
  }
}

/* =======================
   Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø¬Ù„Ø³Ø© ØªØ¯Ø±ÙŠØ¨)
======================= */
const ui = {
  moduleList: document.getElementById("moduleList"),
  activityTitle: document.getElementById("activityTitle"),
  tagMode: document.getElementById("tagMode"),
  tagScore: document.getElementById("tagScore"),
  tagStreak: document.getElementById("tagStreak"),
  explainBox: document.getElementById("explainBox"),
  tipsBox: document.getElementById("tipsBox"),
  btnStart: document.getElementById("btnStart"),
  btnNext: document.getElementById("btnNext"),
  btnStop: document.getElementById("btnStop"),
  progressFill: document.getElementById("progressFill"),
  progressText: document.getElementById("progressText"),
  timeText: document.getElementById("timeText"),
  questionBox: document.getElementById("questionBox"),
  qPrompt: document.getElementById("qPrompt"),
  qKind: document.getElementById("qKind"),
  mcqArea: document.getElementById("mcqArea"),
  inputArea: document.getElementById("inputArea"),
  choices: document.getElementById("choices"),
  answerInput: document.getElementById("answerInput"),
  btnSubmit: document.getElementById("btnSubmit"),
  msgBox: document.getElementById("msgBox"),
  btnResetAll: document.getElementById("btnResetAll"),
  btnTips: document.getElementById("btnTips"),
};

let state = {
  currentModule: MODULES[0],
  questions: [],
  index: 0,
  score: 0,
  streak: 0,
  running: false,
  timer: 0,
  timerId: null,
  selectedChoice: null,
  // persistent progress per module
  progress: loadProgress(),
};

function loadProgress(){
  try{
    const raw = localStorage.getItem("g3_math_progress");
    if(!raw) return {};
    return JSON.parse(raw);
  }catch(e){ return {}; }
}
function saveProgress(){
  localStorage.setItem("g3_math_progress", JSON.stringify(state.progress));
}

function setModule(mod){
  state.currentModule = mod;
  ui.activityTitle.textContent = mod.name;
  ui.tagMode.textContent = "Ø¬Ø§Ù‡Ø²";
  ui.explainBox.innerHTML = "â€¢ " + mod.explain.map(x=>toArabicDigits(x)).join("<br/>â€¢ ");
  ui.tipsBox.style.display = "none";
  ui.questionBox.style.display = "none";
  ui.btnStart.disabled = false;
  ui.btnNext.disabled = true;
  ui.btnStop.disabled = true;
  state.running = false;
  updateScoreTags();
  updateProgressUI(0);
}

function buildModuleList(){
  ui.moduleList.innerHTML = "";
  MODULES.forEach(mod=>{
    const p = state.progress[mod.id] || {best:0, attempts:0};
    const item = document.createElement("div");
    item.className = "pill";
    item.style.width = "100%";
    item.style.justifyContent = "space-between";
    item.style.marginBottom = "10px";
    item.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px">
        <span style="font-size:18px">${mod.icon}</span>
        <div style="display:flex;flex-direction:column;gap:2px">
          <div style="font-weight:900">${mod.name}</div>
          <div class="mini">Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©: ${fmtNum(p.best)} | Ù…Ø­Ø§ÙˆÙ„Ø§Øª: ${fmtNum(p.attempts)}</div>
        </div>
      </div>
      <div style="font-weight:900">â†</div>
    `;
    item.addEventListener("click", ()=> setModule(mod));
    ui.moduleList.appendChild(item);
  });
}

function startSession(){
  const diff = getDifficulty();
  const count = getCount();
  state.questions = [];
  for(let i=0;i<count;i++){
    state.questions.push(state.currentModule.gen(diff));
  }
  state.index = 0;
  state.score = 0;
  state.streak = 0;
  state.running = true;
  ui.tagMode.textContent = "ÙŠØ¹Ù…Ù„";
  ui.btnStart.disabled = true;
  ui.btnNext.disabled = true;
  ui.btnStop.disabled = false;
  ui.questionBox.style.display = "block";
  ui.tipsBox.style.display = "none";
  ui.msgBox.className = "msg";
  ui.msgBox.style.display = "none";
  startTimer();
  renderQuestion();
  updateScoreTags();
  updateProgressUI(0);
}

function stopSession(){
  state.running = false;
  ui.tagMode.textContent = "Ù…ØªÙˆÙ‚Ù";
  ui.btnStart.disabled = false;
  ui.btnNext.disabled = true;
  ui.btnStop.disabled = true;
  stopTimer();
  ui.msgBox.className = "msg ok";
  ui.msgBox.textContent = `Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø© âœ… Ù†ØªÙŠØ¬ØªÙƒ: ${fmtNum(state.score)} Ù…Ù† ${fmtNum(state.questions.length)}.`;
  ui.msgBox.style.display = "block";

  // update persistent best
  const id = state.currentModule.id;
  const p = state.progress[id] || {best:0, attempts:0};
  p.attempts += 1;
  p.best = Math.max(p.best, state.score);
  state.progress[id] = p;
  saveProgress();
  buildModuleList();
}

function startTimer(){
  stopTimer();
  state.timer = 0;
  ui.timeText.textContent = "Ø§Ù„ÙˆÙ‚Øª: Ù  Ø«Ø§Ù†ÙŠØ©";
  state.timerId = setInterval(()=>{
    state.timer++;
    ui.timeText.textContent = `Ø§Ù„ÙˆÙ‚Øª: ${fmtNum(state.timer)} Ø«Ø§Ù†ÙŠØ©`;
  }, 1000);
}
function stopTimer(){
  if(state.timerId){ clearInterval(state.timerId); state.timerId = null; }
}

function updateScoreTags(){
  const total = state.questions.length || 0;
  ui.tagScore.textContent = `Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${fmtNum(state.score)} / ${fmtNum(total)}`;
  ui.tagStreak.textContent = `Ø³Ù„Ø³Ù„Ø©: ${fmtNum(state.streak)}`;
}

function updateProgressUI(){
  const total = state.questions.length || 1;
  const done = state.index;
  const pct = Math.round((done/total)*100);
  ui.progressFill.style.width = pct + "%";
  ui.progressText.textContent = `Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…: ${fmtNum(pct)}Ùª`;
}

function renderQuestion(){
  const q = state.questions[state.index];
  state.selectedChoice = null;

  ui.qKind.textContent = q.kind;
  ui.qPrompt.innerHTML = q.prompt;
  ui.msgBox.className = "msg";
  ui.msgBox.style.display = "none";

  if(q.type === "mcq"){
    ui.mcqArea.style.display = "block";
    ui.inputArea.style.display = "none";
    ui.choices.innerHTML = "";
    q.choices.forEach(ch=>{
      const div = document.createElement("div");
      div.className = "choice";
      div.innerHTML = `<span class="dot"></span><span style="font-weight:900;font-size:16px">${ch}</span>`;
      div.addEventListener("click", ()=>{
        // select
        [...ui.choices.children].forEach(el=> el.classList.remove("selected"));
        div.classList.add("selected");
        state.selectedChoice = ch;
        // auto-check after selection
        checkAnswer();
      });
      ui.choices.appendChild(div);
    });
    ui.btnNext.disabled = true;
  } else {
    ui.mcqArea.style.display = "none";
    ui.inputArea.style.display = "block";
    ui.answerInput.value = "";
    ui.answerInput.focus();
    ui.btnNext.disabled = true;
  }

  // update progress bar to show current index (not answered yet)
  updateProgressUI();
}

function showMsg(ok, text){
  ui.msgBox.className = "msg " + (ok ? "ok" : "bad");
  ui.msgBox.textContent = text;
  ui.msgBox.style.display = "block";
}

function checkAnswer(){
  if(!state.running) return;
  const q = state.questions[state.index];
  let ok = false;

  if(q.type === "mcq"){
    if(state.selectedChoice == null) return;
    ok = String(state.selectedChoice) === String(q.answer);
  }else{
    const raw = ui.answerInput.value;
    const normalized = fromArabicDigits(raw);
    if(normalized === "") return;
    ok = String(Number(normalized)) === String(Number(q.answer));
  }

  if(ok){
    state.score++;
    state.streak++;
    showMsg(true, "Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© âœ… " + (q.explain ? ("â€” " + q.explain) : ""));
  }else{
    state.streak = 0;
    const correctShown = (q.type==="mcq") ? q.answer : fmtNum(q.answer);
    showMsg(false, "Ø¥Ø¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: " + correctShown + (q.explain ? (" â€” " + q.explain) : ""));
  }

  updateScoreTags();
  ui.btnNext.disabled = false;

  // if last question, change next label
  if(state.index === state.questions.length-1){
    ui.btnNext.textContent = "Ø¥Ù†Ù‡Ø§Ø¡";
  }else{
    ui.btnNext.textContent = "Ø§Ù„ØªØ§Ù„ÙŠ";
  }
}

function nextQuestion(){
  if(!state.running) return;
  if(state.index >= state.questions.length-1){
    // finish
    updateProgressUI();
    stopSession();
    return;
  }
  state.index++;
  updateProgressUI();
  renderQuestion();
}

/* =======================
   Ø£Ø­Ø¯Ø§Ø« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
======================= */
ui.btnStart.addEventListener("click", startSession);
ui.btnStop.addEventListener("click", stopSession);
ui.btnNext.addEventListener("click", nextQuestion);
ui.btnSubmit.addEventListener("click", ()=>{ checkAnswer(); });

ui.answerInput.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    checkAnswer();
  }
});

ui.btnResetAll.addEventListener("click", ()=>{
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…ØŸ")){
    localStorage.removeItem("g3_math_progress");
    state.progress = {};
    buildModuleList();
    alert("ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† âœ…");
  }
});

ui.btnTips.addEventListener("click", ()=>{
  ui.tipsBox.style.display = ui.tipsBox.style.display==="none" ? "block" : "none";
  ui.tipsBox.innerHTML = `
    âœ… <b>Ù†ØµØ§Ø¦Ø­ Ø³Ø±ÙŠØ¹Ø©</b><br/>
    â€¢ Ø§Ø¨Ø¯Ø¦ÙŠ Ø¨Ù…Ù‡Ø§Ø±Ø©: <b>Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ + Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©</b> Ù„Ø£Ù†Ù‡Ø§ Ø£Ø³Ø§Ø³ ÙƒÙ„ Ø´ÙŠØ¡.<br/>
    â€¢ ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨: ØªØ°ÙƒØ±ÙŠ <b>Ø§Ù„Ø¨Ø®ÙŠÙ„Ø©</b> (Ù â€“Ù¤) ØªÙ†Ø²Ù„ Ùˆ<b>Ø§Ù„ÙƒØ±ÙŠÙ…Ø©</b> (Ù¥â€“Ù©) ØªØ·Ù„Ø¹.<br/>
    â€¢ ÙÙŠ Ø§Ù„Ø·Ø±Ø­ Ù…Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù: Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙ„Ù Ù…Ù†Ù‡ <b>ÙŠÙ†Ù‚Øµ ÙˆØ§Ø­Ø¯</b>.<br/>
    â€¢ ÙÙŠ Ø§Ù„Ø¶Ø±Ø¨: Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ø¹Ø¯ Ø§Ù„Ù‚ÙØ²ÙŠ Ø«Ù… Ø§Ø±Ø¨Ø·ÙŠÙ‡ Ø¨Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¶Ø±Ø¨.
  `;
});

/* =======================
   ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
======================= */
buildModuleList();
setModule(MODULES[0]);
</script>
</body>
</html>
